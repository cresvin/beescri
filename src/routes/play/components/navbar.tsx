import beescriLogo from "@/assets/beescri.svg";
import { Button } from "@/components/ui/button";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { useEditor } from "@/contexts/editor-context";
import { saveAs } from "file-saver";
import {
  CoreBeautifyOptions,
  css_beautify,
  html_beautify,
  js_beautify,
} from "js-beautify";
import JSZip from "jszip";
import { Link } from "react-router-dom";
import { toast } from "sonner";

export const Navbar = () => {
  return (
    <header className="py-2.5 px-5 border-b flex items-center justify-between">
      <Link to="/">
        <img src={beescriLogo} alt="Beescri" className="size-8" />
      </Link>
      <nav className="space-x-2">
        <FormatButton />
        <ExportButton />
        <a
          href="https://buymeacoffee.com/cresvinn"
          target="_blank"
          rel="noreferrer"
        >
          <Button size="sm">Buy me a ‚òï</Button>
        </a>
      </nav>
    </header>
  );
};

const FormatButton = () => {
  const { html, css, js, changeValue } = useEditor();

  const handleFormat = () => {
    const opts: CoreBeautifyOptions = {
      indent_size: 2,
    };

    changeValue("html", html_beautify(html, opts));
    changeValue("css", css_beautify(css, opts));
    changeValue("js", js_beautify(js, opts));

    toast.success("Formatted!");
  };

  return (
    <Button onClick={handleFormat} size="sm" variant="ghost">
      Format
    </Button>
  );
};

const ExportButton = () => {
  const { html, css, js } = useEditor();

  const handleExport = async () => {
    try {
      const zip = new JSZip();
      zip.file(
        "index.html",
        `
<!DOCTYPE html>
<html lang="en">

<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta charset="UTF-8" />
<link rel="stylesheet" href="style.css" />
<title>My Bee üêù</title>
</head>

<body>
<!-- üêù Auto-generated by ${window.location.href} -->
${html}
<script src="app.js"></script>
</body>

</html>`.trim()
      );
      zip.file("style.css", css);
      zip.file("app.js", js);

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "bee.zip");

      toast.success("Exported successfully");
    } catch (err) {
      if (err instanceof Error) {
        toast.error(`Failed to export: ${err.message}`);
        console.error(err);
      }
    }
  };

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <Button variant="ghost" size="sm" onClick={handleExport}>
            Export
          </Button>
        </TooltipTrigger>
        <TooltipContent>
          <p>Export as zip</p>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
};
